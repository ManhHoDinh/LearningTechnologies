apiVersion: v1
kind: ConfigMap
metadata:
  name: replica-init-cm
data:
  replica-init.sh: |
    #!/bin/sh
    set -e
    DATA_DIR="/var/lib/postgresql/data"

    # Clone only if empty PVC
    if [ -z "$(ls -A "$DATA_DIR" 2>/dev/null)" ]; then
      echo "[init] pg_basebackup from primary..."
      pg_basebackup -h postgres-master -p 5432 -U repuser -D "$DATA_DIR" -Fp -Xs -P
    else
      echo "[init] Data dir not empty, skip basebackup."
    fi

    # Enable standby mode (PG12+)
    [ -f "$DATA_DIR/standby.signal" ] || touch "$DATA_DIR/standby.signal"

    # Replication settings
    {
      echo "primary_conninfo = 'host=postgres-master port=5432 user=repuser password=${PGPASSWORD} application_name=$(hostname)'"
      echo "primary_slot_name = 'replica_1_slot'"
      echo "hot_standby = on"
    } >> "$DATA_DIR/postgresql.auto.conf"

    echo "[init] Standby ready."
